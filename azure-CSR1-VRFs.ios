int gi1
no ip nat outside
int gi2
no ip nat inside

!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
! Tunnel to CSR2 public IP - for HA
!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
interface Tunnel1
 ip address 192.168.101.1 255.255.255.252
 load-interval 30
 tunnel source GigabitEthernet1
 tunnel mode ipsec ipv4
 tunnel destination CSR2PublicIP
 tunnel protection ipsec profile vti-1

!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
! BGP between CSR1 & CSR2 - for HA
!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
router bgp 65001
 bgp router-id 1.1.1.1
 bgp log-neighbor-changes
 neighbor 192.168.101.2 remote-as 65001
 !
 address-family ipv4
  neighbor 192.168.101.2 soft-reconfiguration inbound
  network 1.1.1.1 mask 255.255.255.255
  network 10.225.172.0 mask 255.255.255.0
  network 192.168.1.1 mask 255.255.255.255
  neighbor 192.168.101.2 activate
  neighbor 192.168.101.2 next-hop-self
  network 192.168.101.0 mask 255.255.255.252
 exit-address-family

!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
! Each customer is in a section below with its own VRF tunnel & Routes
!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!

!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
! Customer A
!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
vrf definition VRF-A
 rd 101:101
 !
 address-family ipv4
 exit-address-family
!
crypto ikev2 proposal to-BranchA-proposal 
 encryption aes-cbc-256
 integrity sha1
 group 2
!
crypto ikev2 policy to-BranchA-policy 
 match address local 10.225.172.20
 proposal to-BranchA-proposal
!
crypto ikev2 keyring to-BranchA-keyring
 peer CustomerAPublicIP
  address CustomerAPublicIP
  pre-shared-key Msft123Msft123
 !
!
crypto ikev2 profile to-BranchA-profile
 match address local 10.225.172.20
 match identity remote address 10.100.0.4 255.255.255.255 
 authentication remote pre-share
 authentication local pre-share
 keyring local to-BranchA-keyring
 lifetime 3600
 dpd 10 5 on-demand
!
crypto ipsec transform-set uni-perf esp-aes 256 esp-sha-hmac 
 mode tunnel
crypto ipsec transform-set to-BranchA-TransformSet esp-gcm 256 
 mode tunnel
!
crypto ipsec profile to-BranchA-IPsecProfile
 set transform-set to-BranchA-TransformSet 
 set ikev2-profile to-BranchA-profile
!
crypto ipsec profile vti-1
 set security-association lifetime kilobytes disable
 set security-association lifetime seconds 86400
 set transform-set uni-perf 
 set pfs group2
!
interface Loopback1
vrf forwarding VRF-A
 ip address 1.1.1.1 255.255.255.255
!
interface Tunnel11
 vrf forwarding VRF-A
 ip address 192.168.1.1 255.255.255.255
 ip nat inside
 ip tcp adjust-mss 1350
 tunnel source 10.225.172.20
 tunnel mode ipsec ipv4
 tunnel destination CustomerAPublicIP
 tunnel protection ipsec profile to-BranchA-IPsecProfile
!
interface vasileft1
 vrf forwarding VRF-A
 ip address 172.31.255.0 255.255.255.254
 ip nat outside
 no keepalive
!
interface vasiright1
 ip address 172.31.255.1 255.255.255.254
 no keepalive
!
ip nat pool POOL-A 10.101.1.0 10.101.1.255 netmask 255.255.255.0 type match-host
ip nat inside source list 100 pool POOL-A vrf VRF-A
!
! The following 2 lines should be global
! Route for test vm subnet back out the inside interface.
! .129 (first available IP address) is the Azure Fabric
! 168.63.129.16 is the Azure load balancer
!
ip route 10.225.172.160 255.255.255.240 10.225.172.129
ip route 168.63.129.16 255.255.255.255 10.225.172.129
!
ip route 10.101.1.0 255.255.255.0 vasiright1
ip route 1.1.1.1 255.255.255.255 vasiright1
ip route vrf VRF-A 10.225.172.0 255.255.255.0 vasileft1
ip route vrf VRF-A 10.100.0.0 255.255.0.0 Tunnel11
ip route vrf VRF-A 192.168.1.3 255.255.255.255 Tunnel11
ip route vrf VRF-A 3.3.3.3 255.255.255.255 Tunnel11
access-list 100 permit ip 10.100.0.0 0.0.255.255 any

!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
! Customer B
!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
vrf definition VRF-B
 rd 102:102
 !
 address-family ipv4
 exit-address-family

crypto ikev2 proposal to-BranchB-proposal 
 encryption aes-cbc-256
 integrity sha1
 group 2
!
crypto ikev2 policy to-BranchB-policy 
 match address local 10.225.172.20
 proposal to-BranchB-proposal
!
crypto ikev2 keyring to-BranchB-keyring
 peer CustomerBPublicIP
  address CustomerBPublicIP
  pre-shared-key Msft123Msft123
 !
!
crypto ikev2 profile to-BranchB-profile
 match address local 10.225.172.20
 match identity remote address 10.100.0.5 255.255.255.255 
 authentication remote pre-share
 authentication local pre-share
 keyring local to-BranchB-keyring
 lifetime 3600
 dpd 10 5 on-demand
!
crypto ipsec transform-set uni-perf esp-aes 256 esp-sha-hmac
 mode tunnel
crypto ipsec transform-set to-BranchB-TransformSet esp-gcm 256
 mode tunnel
!
crypto ipsec profile to-BranchB-IPsecProfile
 set transform-set to-BranchB-TransformSet
 set ikev2-profile to-BranchB-profile
!
crypto ipsec profile vti-1
 set security-association lifetime kilobytes disable
 set security-association lifetime seconds 86400
 set transform-set uni-perf 
 set pfs group2
!
interface Loopback2
vrf forwarding VRF-B
 ip address 2.2.2.2 255.255.255.255
!
interface Tunnel12
 vrf forwarding VRF-B
 ip address 192.168.10.1 255.255.255.255
 ip nat inside
 ip tcp adjust-mss 1350
 tunnel source 10.225.172.20
 tunnel mode ipsec ipv4
 tunnel destination CustomerBPublicIP
 tunnel protection ipsec profile to-BranchB-IPsecProfile
!
interface vasileft2
 vrf forwarding VRF-B
 ip address 172.31.255.2 255.255.255.254
 ip nat outside
 no keepalive
!
interface vasiright2
 ip address 172.31.255.3 255.255.255.254
 no keepalive
!
ip nat pool POOL-B 10.102.1.0 10.102.1.255 netmask 255.255.255.0 type match-host
ip nat inside source list 101 pool POOL-B vrf VRF-B
ip route 10.102.1.0 255.255.255.0 vasiright2
ip route 2.2.2.2 255.255.255.255 vasiright2
ip route vrf VRF-B 10.225.172.0 255.255.0.0 vasileft2
ip route vrf VRF-B 10.100.0.0 255.255.0.0 Tunnel12
ip route vrf VRF-A 192.168.10.2 255.255.255.255 Tunnel12
ip route vrf VRF-B 4.4.4.4 255.255.255.255 Tunnel12
access-list 101 permit ip 10.100.0.0 0.0.255.255 any